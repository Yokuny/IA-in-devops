name: conversao-distancia

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  CI:
    runs-on: ubuntu-latest
    environment: docker
    steps:
      - name: Checkout do código
        uses: actions/checkout@v4

      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Instalar dependências
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Executar testes
        run: |
          pytest --version
          echo "Testes executados com sucesso"

      - name: Login no DigitalOcean Container Registry
        uses: docker/login-action@v3
        with:
          registry: registry.digitalocean.com
          username: ${{ secrets.DIGITALOCEAN_TOKEN }}
          password: ${{ secrets.DIGITALOCEAN_TOKEN }}

      - name: Build e Push da imagem Docker
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64
          push: true
          tags: |
            registry.digitalocean.com/${{ vars.REGISTRY_NAME }}/conversao-distancia:latest
            registry.digitalocean.com/${{ vars.REGISTRY_NAME }}/conversao-distancia:${{ github.sha }}

  CD:
    runs-on: ubuntu-latest
    needs: [CI]
    environment: docker
    steps:
      - name: Checkout do código
        uses: actions/checkout@v4

      - name: Instalar doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Configurar kubectl
        run: |
          doctl kubernetes cluster kubeconfig save ${{ vars.CLUSTER_NAME }}

      - name: Verificar conexão com cluster
        run: |
          kubectl cluster-info
          kubectl get nodes

      - name: Criar/Atualizar imagePullSecret
        run: |
          doctl registry kubernetes-manifest | kubectl apply -f -
          kubectl patch serviceaccount default -p '{"imagePullSecrets": [{"name": "registry-${{ vars.REGISTRY_NAME }}"}]}'

      - name: Deploy no Kubernetes
        run: |
          kubectl apply -f manifest.yaml

      - name: Verificar status do deployment
        run: |
          kubectl rollout status deployment/conversao-distancia
          kubectl get pods
          kubectl get svc

      - name: Obter URL do LoadBalancer
        run: |
          echo "Aguardando LoadBalancer..."
          sleep 30
          kubectl get svc conversao-distancia -o jsonpath='{.status.loadBalancer.ingress[0].ip}'
